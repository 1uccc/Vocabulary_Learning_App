import { useState, useEffect } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "./ui/card";
import { Progress } from "./ui/progress";
import { Badge } from "./ui/badge";
import { 
  BookOpen, 
  Target, 
  TrendingUp, 
  BarChart3, 
  Clock, 
  Zap,
  Calendar,
  Award,
  Brain,
  Trophy
} from "lucide-react";
import { safeFirebaseService } from "../lib/firebase-service-wrapper";
import { Topic, Vocabulary, UserProgress } from "./RealFirebaseService";

interface MobileProgressViewProps {
  userId: string;
}

export function MobileProgressView({ userId }: MobileProgressViewProps) {
  const [topics, setTopics] = useState<Topic[]>([]);
  const [vocabularies, setVocabularies] = useState<Vocabulary[]>([]);
  const [userProgress, setUserProgress] = useState<UserProgress[]>([]);
  const [stats, setStats] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadProgressData();
  }, []);

  const loadProgressData = async () => {
    try {
      const [topicsData, vocabulariesData, progressData, statsData] = await Promise.all([
        safeFirebaseService.getTopics(userId),
        safeFirebaseService.getVocabularies(userId),
        safeFirebaseService.getUserProgress(userId),
        safeFirebaseService.getLearningStats(userId, 30)
      ]);

      setTopics(topicsData);
      setVocabularies(vocabulariesData);
      setUserProgress(progressData);
      setStats(statsData);
    } catch (error) {
      console.error('Failed to load progress data:', error);
    } finally {
      setLoading(false);
    }
  };

  const getTopicProgress = (topicId: string) => {
    const topicVocabs = vocabularies.filter(v => v.topicId === topicId);
    const topicProgressData = userProgress.filter(p => 
      topicVocabs.some(v => v.id === p.vocabularyId)
    );
    const learned = topicProgressData.filter(p => p.learned).length;
    const totalCorrect = topicProgressData.reduce((sum, p) => sum + p.correctCount, 0);
    const totalIncorrect = topicProgressData.reduce((sum, p) => sum + p.incorrectCount, 0);
    const totalAttempts = totalCorrect + totalIncorrect;
    
    return {
      total: topicVocabs.length,
      learned,
      percentage: topicVocabs.length > 0 ? (learned / topicVocabs.length) * 100 : 0,
      accuracy: totalAttempts > 0 ? (totalCorrect / totalAttempts) * 100 : 0
    };
  };

  const getProgressLevel = (percentage: number) => {
    if (percentage >= 90) return { label: "Th√†nh th·∫°o", color: "text-green-600", bg: "bg-green-100" };
    if (percentage >= 70) return { label: "Gi·ªèi", color: "text-blue-600", bg: "bg-blue-100" };
    if (percentage >= 50) return { label: "Kh√°", color: "text-yellow-600", bg: "bg-yellow-100" };
    return { label: "C·∫ßn c·∫£i thi·ªán", color: "text-red-600", bg: "bg-red-100" };
  };

  const getStreakMessage = (streak: number) => {
    if (streak >= 30) return "Si√™u sao! üåü";
    if (streak >= 14) return "Tuy·ªát v·ªùi! üî•";
    if (streak >= 7) return "T·ªët l·∫Øm! ‚ö°";
    if (streak >= 3) return "Ti·∫øp t·ª•c! üí™";
    return "B·∫Øt ƒë·∫ßu th√¥i! üöÄ";
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
      </div>
    );
  }

  const overallProgress = stats ? (stats.learnedWords / stats.totalWords) * 100 : 0;
  const level = getProgressLevel(overallProgress);

  return (
    <div className="space-y-6 pb-20">
      {/* Header */}
      <div className="text-center">
        <h2 className="text-lg font-semibold mb-2">Ti·∫øn ƒë·ªô h·ªçc t·∫≠p</h2>
        <div className="text-4xl mb-2">
          {overallProgress >= 90 ? "üèÜ" : overallProgress >= 70 ? "üéØ" : overallProgress >= 50 ? "üìö" : "üå±"}
        </div>
        <Badge className={`${level.bg} ${level.color} border-0`}>
          {level.label}
        </Badge>
      </div>

      {/* Overall Stats */}
      <div className="grid grid-cols-2 gap-4">
        <Card className="bg-gradient-to-br from-primary/10 to-blue-100">
          <CardContent className="p-4 text-center">
            <BookOpen className="h-6 w-6 text-primary mx-auto mb-2" />
            <div className="text-2xl font-bold text-primary">
              {stats?.totalWords || 0}
            </div>
            <div className="text-sm text-muted-foreground">T·ªïng t·ª´ v·ª±ng</div>
          </CardContent>
        </Card>

        <Card className="bg-gradient-to-br from-green-50 to-green-100">
          <CardContent className="p-4 text-center">
            <Target className="h-6 w-6 text-green-600 mx-auto mb-2" />
            <div className="text-2xl font-bold text-green-600">
              {stats?.learnedWords || 0}
            </div>
            <div className="text-sm text-muted-foreground">ƒê√£ h·ªçc</div>
          </CardContent>
        </Card>

        <Card className="bg-gradient-to-br from-accent/10 to-yellow-100">
          <CardContent className="p-4 text-center">
            <TrendingUp className="h-6 w-6 text-accent mx-auto mb-2" />
            <div className="text-2xl font-bold text-accent">
              {Math.round(stats?.averageAccuracy || 0)}%
            </div>
            <div className="text-sm text-muted-foreground">ƒê·ªô ch√≠nh x√°c</div>
          </CardContent>
        </Card>

        <Card className="bg-gradient-to-br from-purple-50 to-purple-100">
          <CardContent className="p-4 text-center">
            <Zap className="h-6 w-6 text-purple-600 mx-auto mb-2" />
            <div className="text-2xl font-bold text-purple-600">
              {stats?.streak || 0}
            </div>
            <div className="text-sm text-muted-foreground">Streak</div>
          </CardContent>
        </Card>
      </div>

      {/* Progress Overview */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <BarChart3 className="h-5 w-5" />
            T·ªïng quan ti·∫øn ƒë·ªô
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <div className="flex justify-between text-sm mb-2">
              <span>Ho√†n th√†nh</span>
              <span>{Math.round(overallProgress)}%</span>
            </div>
            <Progress value={overallProgress} className="h-3" />
          </div>

          <div className="grid grid-cols-2 gap-4 text-sm">
            <div className="flex justify-between">
              <span className="text-muted-foreground">ƒê√£ h·ªçc:</span>
              <span className="font-medium text-green-600">{stats?.learnedWords || 0}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-muted-foreground">C√≤n l·∫°i:</span>
              <span className="font-medium text-blue-600">
                {(stats?.totalWords || 0) - (stats?.learnedWords || 0)}
              </span>
            </div>
            <div className="flex justify-between">
              <span className="text-muted-foreground">Phi√™n h·ªçc:</span>
              <span className="font-medium">{stats?.sessionsCount || 0}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-muted-foreground">Th·ªùi gian:</span>
              <span className="font-medium">
                {Math.floor((stats?.timeSpent || 0) / 60)}m
              </span>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Streak Card */}
      <Card className="bg-gradient-to-r from-orange-400 to-red-400 text-white">
        <CardContent className="p-6 text-center">
          <div className="text-4xl mb-2">üî•</div>
          <div className="text-2xl font-bold mb-1">{stats?.streak || 0} ng√†y</div>
          <div className="text-orange-100 mb-2">Chu·ªói h·ªçc li√™n ti·∫øp</div>
          <div className="text-sm font-medium">
            {getStreakMessage(stats?.streak || 0)}
          </div>
        </CardContent>
      </Card>

      {/* Topics Progress */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Brain className="h-5 w-5" />
            Ti·∫øn ƒë·ªô theo ch·ªß ƒë·ªÅ
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {topics.map((topic) => {
            const progress = getTopicProgress(topic.id);
            const level = getProgressLevel(progress.percentage);
            
            return (
              <div
                key={topic.id}
                className="p-4 rounded-2xl border hover:bg-muted/30 transition-colors"
              >
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-3">
                    <div 
                      className="w-4 h-4 rounded-full"
                      style={{ backgroundColor: topic.color }}
                    />
                    <h3 className="font-medium">{topic.name}</h3>
                  </div>
                  <div className="flex items-center gap-2">
                    <Badge className={`${level.bg} ${level.color} border-0 text-xs`}>
                      {level.label}
                    </Badge>
                    <Badge variant="outline" className="text-xs">
                      {progress.learned}/{progress.total}
                    </Badge>
                  </div>
                </div>
                
                <div className="space-y-2">
                  <div className="flex justify-between text-xs text-muted-foreground">
                    <span>Ti·∫øn ƒë·ªô: {Math.round(progress.percentage)}%</span>
                    <span>ƒê·ªô ch√≠nh x√°c: {Math.round(progress.accuracy)}%</span>
                  </div>
                  <Progress value={progress.percentage} className="h-2" />
                </div>
              </div>
            );
          })}
          
          {topics.length === 0 && (
            <div className="text-center py-8 text-muted-foreground">
              <BookOpen className="h-12 w-12 mx-auto mb-4 opacity-50" />
              <p>Ch∆∞a c√≥ ch·ªß ƒë·ªÅ n√†o ƒë·ªÉ theo d√µi</p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Achievement & Tips */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Award className="h-5 w-5" />
            Th√†nh t√≠ch & L·ªùi khuy√™n
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          {/* Achievements */}
          <div className="grid grid-cols-3 gap-2">
            <div className={`p-3 rounded-xl text-center ${stats?.streak >= 7 ? 'bg-yellow-100' : 'bg-gray-100'}`}>
              <div className="text-2xl mb-1">üî•</div>
              <div className="text-xs font-medium">Streak 7</div>
            </div>
            <div className={`p-3 rounded-xl text-center ${stats?.learnedWords >= 50 ? 'bg-blue-100' : 'bg-gray-100'}`}>
              <div className="text-2xl mb-1">üìö</div>
              <div className="text-xs font-medium">50 t·ª´</div>
            </div>
            <div className={`p-3 rounded-xl text-center ${stats?.averageAccuracy >= 80 ? 'bg-green-100' : 'bg-gray-100'}`}>
              <div className="text-2xl mb-1">üéØ</div>
              <div className="text-xs font-medium">80% ch√≠nh x√°c</div>
            </div>
          </div>

          {/* Tips */}
          <div className="space-y-2 text-sm">
            {stats?.averageAccuracy < 70 && (
              <div className="bg-yellow-50 p-3 rounded-xl border border-yellow-200">
                <p className="text-yellow-700">
                  üí° <strong>M·∫πo:</strong> H√£y s·ª≠ d·ª•ng Flashcard nhi·ªÅu h∆°n ƒë·ªÉ c·∫£i thi·ªán ƒë·ªô ch√≠nh x√°c tr∆∞·ªõc khi l√†m Quiz.
                </p>
              </div>
            )}
            {overallProgress < 50 && (
              <div className="bg-blue-50 p-3 rounded-xl border border-blue-200">
                <p className="text-blue-700">
                  üìà <strong>M·ª•c ti√™u:</strong> H√£y d√†nh 15-20 ph√∫t m·ªói ng√†y ƒë·ªÉ h·ªçc t·ª´ v·ª±ng ƒë·ªÅu ƒë·∫∑n.
                </p>
              </div>
            )}
            {stats?.streak < 3 && (
              <div className="bg-orange-50 p-3 rounded-xl border border-orange-200">
                <p className="text-orange-700">
                  üî• <strong>Th·ª≠ th√°ch:</strong> H√£y h·ªçc li√™n ti·∫øp 3 ng√†y ƒë·ªÉ b·∫Øt ƒë·∫ßu chu·ªói streak c·ªßa b·∫°n!
                </p>
              </div>
            )}
            {overallProgress >= 80 && stats?.averageAccuracy >= 85 && (
              <div className="bg-green-50 p-3 rounded-xl border border-green-200">
                <p className="text-green-700">
                  üèÜ <strong>Xu·∫•t s·∫Øc!</strong> B·∫°n ƒëang h·ªçc r·∫•t t·ªët. H√£y ti·∫øp t·ª•c duy tr√¨!
                </p>
              </div>
            )}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}